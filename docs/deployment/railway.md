# Railway Deployment Guide (Railpack)

Deploy the project as two Railway services that share the repository but use different roots:

- **Backend** (Python Railpack, root: `.`)
- **Frontend** (Node Railpack, root: `frontend`)

## Prerequisites

1. Railway account and CLI (`npm i -g railway`).
2. Authenticated local CLI (`railway login`).
3. Required cloud services configured (Azure OpenAI, Azure Storage, Azure Document Intelligence, Supabase, optional OpenAI).
4. All secrets copied into your Railway project (see `.env.example`).

Push the repo to GitHub before linking so Railway can auto-build on commits.

## Backend Service (root `.`)

Railway detects the Python Railpack from `requirements.txt`. The `Procfile` defines the start command (`uvicorn api.app:app ...`).

1. `railway init` in the repo (or create the project in the dashboard and connect GitHub).
2. Create a service from the repo and set the **Root Directory** to `.` (the default).
   - In Railway dashboard: Settings → Source → Root Directory: `.`
3. Set environment variables:
   - `AZURE_OPENAI_ENDPOINT`, `AZURE_OPENAI_KEY`, `AZURE_OPENAI_API_VERSION`, `AZURE_OPENAI_DEPLOYMENT`
   - `AZURE_STORAGE_CONNECTION_STRING`
   - `AZURE_DOCUMENT_INTELLIGENCE_ENDPOINT`, `AZURE_DOCUMENT_INTELLIGENCE_KEY`
   - `SUPABASE_URL`, `SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
   - `EVALUATION_PIPELINE` (set to `vision` unless you restore the Azure pipeline)
   - `OPENAI_API_KEY` if you rely on the vision evaluator
4. Set the health check path to `/api/health`.
5. Deploy. The Railpack will install dependencies, run migrations (if defined), and start `uvicorn`. Confirm with `railway logs` and `curl https://<backend-domain>/api/health`.

## Frontend Service (root `frontend`)

The Node Railpack installs dependencies, runs the `build` script, then the `start` script from `package.json` (which runs `vite preview`).

1. Add a second service pointing to the same Git repo.
2. **CRITICAL**: Override the **Root Directory** to `frontend`.
   - In Railway dashboard: Settings → Source → Root Directory: `frontend`
   - Without this, Railway will fail to find `index.html` during the Vite build
3. Ensure `VITE_API_BASE_URL` is set (for example `https://<backend-domain>/api`).
4. Deploy. Build output is generated by `npm run build` and served via `npm run start` (bound to `PORT`).
5. Visit the provided Railway domain and verify the UI loads and can call the backend using the configured base URL.

## Validation Checklist

- `curl https://<backend-domain>/api/health` returns `{"status":"ok", ...}`.
- Uploading a sample document through the UI queues an evaluation and writes to Supabase.
- Frontend network calls target the deployed backend (confirm in browser devtools).
- Railway dashboards show green health checks for both services.

## Helpful CLI Commands

```bash
railway status                    # Overall project status
railway logs --service backend    # Tail backend logs
railway logs --service frontend   # Tail frontend logs
railway variables --service backend set KEY=VALUE
railway open                      # Open project dashboard
```

Secrets stay in Railway variables. Use `.env` locally only.
